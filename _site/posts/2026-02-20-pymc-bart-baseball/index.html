<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ryan Plain">
<meta name="dcterms.date" content="2026-02-20">
<meta name="description" content="Replicating a PyMC Labs BART example for predicting pitcher whiff rates, with a look at hierarchical park effects and a Python tidybayes package.">

<title>Just Plain Data - BART Baseball with PyMC</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Just Plain Data</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rplain1" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://bsky.app/profile/ryanplain.bsky.social" rel="" target=""><i class="bi bi-bluesky" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">BART Baseball with PyMC</h1>
                  <div>
        <div class="description">
          Replicating a PyMC Labs BART example for predicting pitcher whiff rates, with a look at hierarchical park effects and a Python tidybayes package.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Bayesian</div>
                <div class="quarto-category">PyMC</div>
                <div class="quarto-category">BART</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Ryan Plain </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 20, 2026</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>PyMC Labs put out a post recently called <a href="https://www.pymc-labs.com/blog-posts/bayesian-additive-regression-tree-swinging-strikes">Modeling Swinging Strikes with Bayesian Additive Regression Trees (BART)</a>. It goes over implementing BART models in PyMC and provides a nuanced use case.</p>
<p>At first I was largely dissapointed that only some of the code was included. While it would have been nice to have more of the sports logic to help replicate it, it did describe it through text. I have a better understanding now about the balance of detail in a post after working on this one. To include all the code would have required more time discussing the process, which takes away from the main premise of demonstrating the model.</p>
<p>The work following is my attempt at recreating the models, visualizations, and analysis.</p>
<p>Additionally, being an R enthusiast I built a <a href="https://github.com/rplain1/bayestidy">bayestidy</a> package that replicates some of what <a href="https://mjskay.github.io/tidybayes/">Tidybayes</a> does for the R ecosystem. This is an opinonated framework to working with the posterior distributions, built on previous work I’ve done.</p>
<section id="imports" class="level2">
<h2 class="anchored" data-anchor-id="imports">Imports</h2>
<p>The original post mentions that all of this can be run on a local laptop. It <em>can</em> be done on a local laptop… technically. My machine is quite small relative to today’s standards with 16 gb of memory, so that was a bit of a stretch.</p>
<p>I have simple <code>RERUN</code> flag to compile the models or not. To work more efficiently I saved the models to disk and subsequently loaded them back in with context managers to access what was needed. This way I didn’t have to have all of it in memory at once, which was critical to render the document.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I leveraged Claude to understand how to get PyMC to render in quarto and jupyter. The first set of imports handle that, and LLM commented as such.</p>
<p>I never figured that out on my own, and ran the chains consecutively in previous posts…</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Python's multiprocessing spawn code assumes __main__.__spec__ exists,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.scale <span class="im">import</span> scale_continuous</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># but Jupyter/Quarto kernels don't set it. Fix before pymc_bart imports.</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(sys.modules.get(<span class="st">"__main__"</span>), <span class="st">"__spec__"</span>):</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    sys.modules[<span class="st">"__main__"</span>].__spec__ <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pybaseball <span class="im">import</span> statcast, cache</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc_bart <span class="im">as</span> pmb</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> bayestidy <span class="im">as</span> bt</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_bart.utils <span class="im">import</span> _sample_posterior  <span class="co"># needed for BART with new session</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Set to True to re-fetch data from pybaseball and refit the model</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>RERUN <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> RERUN <span class="kw">or</span> <span class="kw">not</span> Path(<span class="st">"data/df.parquet"</span>).exists():</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    cache.disable()</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> statcast(start_dt<span class="op">=</span><span class="st">"2024-03-28"</span>, end_dt<span class="op">=</span><span class="st">"2024-09-29"</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    pl.from_pandas(df).write_parquet(<span class="st">"data/df.parquet"</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pl.read_parquet(<span class="st">"data/df.parquet"</span>).to_pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plotting functions below.</p>
<div class="cell" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calibration_plot(p_hat, y, label<span class="op">=</span><span class="st">"Train"</span>):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    cal_df <span class="op">=</span> pl.DataFrame({<span class="st">"p_hat"</span>: p_hat.astype(np.float64), <span class="st">"y"</span>: y})</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    breaks <span class="op">=</span> np.linspace(cal_df[<span class="st">"p_hat"</span>].<span class="bu">min</span>(), cal_df[<span class="st">"p_hat"</span>].<span class="bu">max</span>(), <span class="dv">11</span>)[</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    ].tolist()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    cal_summary <span class="op">=</span> (</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        cal_df.with_columns(pl.col(<span class="st">"p_hat"</span>).cut(breaks).alias(<span class="st">"bin"</span>))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        .group_by(<span class="st">"bin"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>            pred_mean<span class="op">=</span>pl.col(<span class="st">"p_hat"</span>).mean(),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            obs_mean<span class="op">=</span>pl.col(<span class="st">"y"</span>).mean(),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            n<span class="op">=</span>pl.col(<span class="st">"y"</span>).count(),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        .sort(<span class="st">"pred_mean"</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        .to_pandas()</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        ggplot(cal_summary, aes(<span class="st">"pred_mean"</span>, <span class="st">"obs_mean"</span>, size<span class="op">=</span><span class="st">"n"</span>))</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> geom_abline(intercept<span class="op">=</span><span class="dv">0</span>, slope<span class="op">=</span><span class="dv">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> geom_point(color<span class="op">=</span><span class="st">"#FF8C69"</span>, alpha<span class="op">=</span><span class="fl">0.85</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> scale_size_continuous(<span class="bu">range</span><span class="op">=</span>(<span class="dv">2</span>, <span class="dv">14</span>), name<span class="op">=</span><span class="st">"N Pitches"</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> labs(</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="ss">f"Calibration Plot (</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> Data)"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">"Predicted Whiff Probability"</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="st">"Observed Whiff Rate"</span>,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> theme_minimal()</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> coord_cartesian(xlim<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.5</span>], ylim<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.5</span>])</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_whiff_plus(df):</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"p_hat"</span> <span class="kw">in</span> df.columns, <span class="st">"dataframe does not have `p_hat`"</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    p_hat <span class="op">=</span> pl.col(<span class="st">"p_hat"</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.with_columns(whiff_plus<span class="op">=</span><span class="dv">100</span> <span class="op">+</span> <span class="dv">10</span> <span class="op">*</span> (p_hat <span class="op">-</span> p_hat.mean()) <span class="op">/</span> p_hat.std())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="model" class="level2">
<h2 class="anchored" data-anchor-id="model">Model</h2>
<p>The first model replicates PyMC Lab’s 4-feature model. If my sports logic is somewhat correct for how they filtered the data, the rest was fairly straightforward.</p>
<ul>
<li>filter for <code>4-Seam Fastball</code></li>
<li>calculate whiffs as swings</li>
<li>I removed 200 records with null values</li>
<li>Split into train/test splits</li>
</ul>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"release_speed"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pfx_x"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pfx_z"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"release_spin_rate"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"description"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pitcher"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"player_name"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>pitch_name <span class="op">=</span> <span class="st">"4-Seam Fastball"</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># this came from assessing the following and removing bunts</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># df.assign(swing = lambda x: ~x['swing_length'].isna()).groupby(['swing', 'description']).count()</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>swings <span class="op">=</span> [</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hit_into_play"</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"swinging_strike"</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"foul_tip"</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"swinging_strike_blocked"</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"foul"</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>whiffs <span class="op">=</span> [<span class="st">"swinging_strike"</span>, <span class="st">"swinging_strike_blocked"</span>]</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>df_model <span class="op">=</span> df.copy().query(<span class="ss">f'pitch_name == "</span><span class="sc">{</span>pitch_name<span class="sc">}</span><span class="ss">" and description in </span><span class="sc">{</span>swings<span class="sc">}</span><span class="ss">'</span>)[</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    cols</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>df_model <span class="op">=</span> df_model.dropna()</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Hold out 20 random pitchers for test set</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">42</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>pitchers <span class="op">=</span> df_model[<span class="st">"pitcher"</span>].unique()</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>holdout_pitchers <span class="op">=</span> rng.choice(pitchers, size<span class="op">=</span><span class="dv">20</span>, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>train_mask <span class="op">=</span> <span class="op">~</span>df_model[<span class="st">"pitcher"</span>].isin(holdout_pitchers)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>feature_cols <span class="op">=</span> [<span class="st">"release_speed"</span>, <span class="st">"pfx_x"</span>, <span class="st">"pfx_z"</span>, <span class="st">"release_spin_rate"</span>]</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df_model[<span class="st">"description"</span>].isin(whiffs).astype(<span class="bu">int</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize features to z-scores (fit on train only)</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> scaler.fit_transform(df_model.loc[train_mask, feature_cols])</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> scaler.transform(df_model.loc[<span class="op">~</span>train_mask, feature_cols])</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> y[train_mask].values</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y[<span class="op">~</span>train_mask].values</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>player_names_train <span class="op">=</span> df_model.loc[train_mask, <span class="st">"player_name"</span>].values</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>coords <span class="op">=</span> {<span class="st">"obs"</span>: player_names_train}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Working with the posterior <code>az.InferenceData</code> object turned out to have different behavior than expected. One of the biggest gotchas was how BART models are saved to disk, and the tree information you lose when starting a new session. I’ve implemented it below, but it is covered in this <a href="https://github.com/pymc-devs/pymc-bart/issues/123#issuecomment-3105432020">GitHub issue</a></p>
<p>Essentially I was able to still save the object and load it into new sessions to continue working with the posterior, however the tree information was not saved with the object (that is the extent of my understanding). Coming back to this in a new session, only the posterior distributions for the saved parameters and values were available. Predictions were all off.</p>
<p>I ended up finding a solution documented in this <a href="https://github.com/pymc-devs/pymc-bart/issues/123#issuecomment-3105432020">GitHub issue</a>.</p>
<p>So here, I’m saving the <code>az.InferenceData</code> object and additionally a pickle file of the trees. Later on I used the functions in that github issue to do predictions.</p>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    RERUN</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">or</span> <span class="kw">not</span> Path(<span class="st">"models/trace.nc"</span>).exists()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">or</span> <span class="kw">not</span> Path(<span class="st">"models/bart_trees.pkl"</span>).exists()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pm.Model(coords<span class="op">=</span>coords) <span class="im">as</span> bart_model:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        X_data <span class="op">=</span> pm.Data(<span class="st">"X_data"</span>, X_train, dims<span class="op">=</span>(<span class="st">"obs"</span>, <span class="st">"feature"</span>))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        y_data <span class="op">=</span> pm.Data(<span class="st">"y_data"</span>, y_train, dims<span class="op">=</span><span class="st">"obs"</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        mu_bart <span class="op">=</span> pmb.BART(<span class="st">"mu_bart"</span>, X<span class="op">=</span>X_data, Y<span class="op">=</span>y_data, m<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> pm.Deterministic(<span class="st">"mu"</span>, mu_bart, dims<span class="op">=</span><span class="st">"obs"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> pm.Deterministic(<span class="st">"p"</span>, pm.math.sigmoid(mu), dims<span class="op">=</span><span class="st">"obs"</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        pm.Bernoulli(<span class="st">"y_obs"</span>, p<span class="op">=</span>p, observed<span class="op">=</span>y_data, dims<span class="op">=</span><span class="st">"obs"</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        idata <span class="op">=</span> pm.sample(draws<span class="op">=</span><span class="dv">2000</span>, chains<span class="op">=</span><span class="dv">2</span>, random_seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    idata.to_netcdf(<span class="st">"models/trace.nc"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> idata</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    all_trees <span class="op">=</span> <span class="bu">list</span>(mu_bart.owner.op.all_trees)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/bart_trees.pkl"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        pickle.dump(all_trees, f)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/bart_trees.pkl"</span>, <span class="st">"rb"</span>) <span class="im">as</span> f:</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        all_trees <span class="op">=</span> pickle.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="working-with-constraints" class="level3">
<h3 class="anchored" data-anchor-id="working-with-constraints">Working with constraints</h3>
<p>The <code>p_train</code> aggregation is used for the calibration plots.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> xr.open_dataset(<span class="st">"models/trace.nc"</span>, group<span class="op">=</span><span class="st">"posterior"</span>) <span class="im">as</span> post:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    p_train <span class="op">=</span> post[<span class="st">"p"</span>].mean(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)).values</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    obs_names_train <span class="op">=</span> post.coords[<span class="st">"obs"</span>].values</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> xr.open_dataset(<span class="st">"models/trace.nc"</span>, group<span class="op">=</span><span class="st">"observed_data"</span>) <span class="im">as</span> obs_data:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> obs_data[<span class="st">"y_obs"</span>].values</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Update coords to match the saved model's obs ordering</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>coords <span class="op">=</span> {<span class="st">"obs"</span>: obs_names_train}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="test-set" class="level3">
<h3 class="anchored" data-anchor-id="test-set">Test Set</h3>
<p>The workaround for BART in new sessions is to use <code>pymc_bart.utils._sample_posterior()</code>. Unlike most Bayesian models I’ve worked with, the predictions are from the trees and not a draw from a combination of parameters. I beleive if I wanted to sample the posterior predictive values for the test set, I could have done something like this:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> bart_model:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    pm.set_data({<span class="st">"X_data"</span>: X_test})</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    ppc <span class="op">=</span> pm.sample_posterior_predictive(idata, var_names<span class="op">=</span>[<span class="st">"mu"</span>, <span class="st">"p"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then saved that with the <code>az.Inferencedata</code> object. For the BART model, the calibrations on the test set give insight to the validity of the model’s ability to predict, so I didn’t go through that process here.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">42</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>mu_test_samples <span class="op">=</span> _sample_posterior(all_trees, X_test, rng<span class="op">=</span>rng, size<span class="op">=</span><span class="dv">500</span>, shape<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># shape: (500, n_test, 1) → squeeze last dim → (500, n_test)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>mu_test_samples <span class="op">=</span> mu_test_samples.squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>p_test <span class="op">=</span> (<span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(<span class="op">-</span>mu_test_samples))).mean(axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calibration-plots" class="level3">
<h3 class="anchored" data-anchor-id="calibration-plots">Calibration Plots</h3>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>calibration_plot(p_train, y_train, label<span class="op">=</span><span class="st">"Train"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<p><img src="index_files/figure-html/cell-9-output-1.png" width="672" height="480"></p>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>calibration_plot(p_test, y_test, label<span class="op">=</span><span class="st">"Test"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<p><img src="index_files/figure-html/cell-10-output-1.png" width="672" height="480"></p>
</div>
</div>
<p>Looking good!</p>
</section>
</section>
<section id="whiff" class="level2">
<h2 class="anchored" data-anchor-id="whiff">Whiff+</h2>
<p>I appreciated this metric as I have little to no domain knowledge in baseball. The pitcher names could be replaced with human-readable uuids and it would not effect on my ability to work with the data.</p>
<div class="cell" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(df, pl.DataFrame):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pl.from_pandas(df)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> pl.DataFrame({</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"player_name"</span>: obs_names_train,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_hat"</span>: p_train.astype(np.float64),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>}).pipe(add_whiff_plus)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> pl.from_pandas(df_model.loc[<span class="op">~</span>train_mask].assign(p_hat<span class="op">=</span>p_test)).pipe(add_whiff_plus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="median-whiff-plus-leaderboard---training-set" class="level3">
<h3 class="anchored" data-anchor-id="median-whiff-plus-leaderboard---training-set">Median whiff plus leaderboard - training set</h3>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>leaderboard <span class="op">=</span> df_train.group_by(<span class="st">"player_name"</span>).agg(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"whiff_plus"</span>).median()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>).sort(<span class="st">"whiff_plus"</span>, descending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>leaderboard</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (730, 2)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">player_name</th>
<th data-quarto-table-cell-role="th">whiff_plus</th>
</tr>
<tr class="odd">
<th>str</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"Kopech, Michael"</td>
<td>125.462949</td>
</tr>
<tr class="even">
<td>"Montgomery, Mason"</td>
<td>124.361451</td>
</tr>
<tr class="odd">
<td>"Helsley, Ryan"</td>
<td>120.247161</td>
</tr>
<tr class="even">
<td>"Ort, Kaleb"</td>
<td>119.918061</td>
</tr>
<tr class="odd">
<td>"Estrada, Jeremiah"</td>
<td>119.773609</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>"Lyles, Jordan"</td>
<td>83.248874</td>
</tr>
<tr class="even">
<td>"Dunning, Dane"</td>
<td>83.025733</td>
</tr>
<tr class="odd">
<td>"Lively, Ben"</td>
<td>82.574925</td>
</tr>
<tr class="even">
<td>"Rogers, Tyler"</td>
<td>82.3153</td>
</tr>
<tr class="odd">
<td>"Crawford, Brandon"</td>
<td>82.221916</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="visualizing-the-leaderboard" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-the-leaderboard">Visualizing the leaderboard</h3>
<p>The size of the dataset did not lend well to work with the new package. In its current state, <code>bayestidy</code> will convert everything to pandas in underlying <code>plotnine</code> functions, as it is yet to have first class <code>polars</code> support.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This is a long-standing <a href="https://github.com/has2k1/plotnine/issues/602">issue</a> that needs a solution, outside of polars from what I can tell.</p>
</div>
</div>
</div>
<p>The tidybayes approach would have been something like the following:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fit  <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_df</span>() <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(player <span class="sc">%in%</span> player_names) <span class="sc">|&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(value, player_name)) <span class="sc">|&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_halfeye</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With this size of dataset, <code>bt.spread_draws()</code> also really struggled here. I’m still learning how I can make this better, but for now I compute whiff+ in xarray space across the full pitcher population before subsetting.</p>
<p>At least I can still use the tidy framework for plotting!</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> whiff_plus_plot(leaderboard, post, coords, n<span class="op">=</span><span class="dv">15</span>, top<span class="op">=</span><span class="va">True</span>, var<span class="op">=</span><span class="st">"p"</span>):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    players <span class="op">=</span> (leaderboard.head(n) <span class="cf">if</span> top <span class="cf">else</span> leaderboard.tail(n))[</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"player_name"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    ].to_list()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> np.where(np.isin(coords[<span class="st">"obs"</span>], players))[<span class="dv">0</span>]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    p_da <span class="op">=</span> post[var]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    p_mean <span class="op">=</span> p_da.mean(dim<span class="op">=</span><span class="st">"obs"</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    p_std <span class="op">=</span> p_da.std(dim<span class="op">=</span><span class="st">"obs"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    whiff_plus_da <span class="op">=</span> (<span class="dv">100</span> <span class="op">+</span> <span class="dv">10</span> <span class="op">*</span> (p_da <span class="op">-</span> p_mean) <span class="op">/</span> p_std).isel(obs<span class="op">=</span>indices)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    df_draws <span class="op">=</span> bt.spread_draws(</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        whiff_plus_da.to_dataset(name<span class="op">=</span><span class="st">"whiff_plus"</span>), <span class="st">"whiff_plus"</span>, group<span class="op">=</span><span class="va">None</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> (</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        df_draws.group_by(<span class="st">"obs"</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        .agg(pl.col(<span class="st">"whiff_plus"</span>).mean())</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        .sort(<span class="st">"whiff_plus"</span>)[<span class="st">"obs"</span>]</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        .to_list()</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    plot_data <span class="op">=</span> df_draws.group_by(<span class="st">"obs"</span>).map_groups(</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> df: df.sample(n<span class="op">=</span><span class="bu">min</span>(<span class="dv">100_000</span>, <span class="bu">len</span>(df)), with_replacement<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"Top </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> Whiff+"</span> <span class="cf">if</span> top <span class="cf">else</span> <span class="ss">f"Bottom </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> Whiff+"</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    fill <span class="op">=</span> <span class="st">"lightblue"</span> <span class="cf">if</span> top <span class="cf">else</span> <span class="st">"lightsalmon"</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        ggplot(plot_data, aes(<span class="st">"whiff_plus"</span>, <span class="st">"obs"</span>))</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> bt.stat_halfeye(fill<span class="op">=</span>fill, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> scale_y_discrete(limits<span class="op">=</span>order)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> labs(title<span class="op">=</span>title, x<span class="op">=</span><span class="st">"Whiff+"</span>, y<span class="op">=</span><span class="st">"Pitcher"</span>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> theme_minimal()</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> xr.open_dataset(<span class="st">"models/trace.nc"</span>, group<span class="op">=</span><span class="st">"posterior"</span>) <span class="im">as</span> post:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    plot_top <span class="op">=</span> whiff_plus_plot(leaderboard, post, coords, n<span class="op">=</span><span class="dv">10</span>, top<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    plot_bottom <span class="op">=</span> whiff_plus_plot(leaderboard, post, coords, n<span class="op">=</span><span class="dv">10</span>, top<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>plot_top</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="30">
<p><img src="index_files/figure-html/cell-14-output-1.png" width="672" height="480"></p>
</div>
</div>
<div class="cell" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>plot_bottom</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="31">
<p><img src="index_files/figure-html/cell-15-output-1.png" width="672" height="480"></p>
</div>
</div>
</section>
</section>
<section id="model-improved" class="level2">
<h2 class="anchored" data-anchor-id="model-improved">Model (Improved)</h2>
<p>Next to implement their improved model, which included a lot of baseball physics that I barely grasp. I’m just trying to learn BART to be able to use it in a domain I’m familiar with, so this logic was mostly LLM generated.</p>
<p>What I did find incredibly useful was it’s combination of a hierarchical component for park, in conjunction with a tree based model. PyMC made this really slick to implement.</p>
<p>Logic to setup the training and test sets below. They both have similar training splits, but I have inconsistent coordinate mappings and it is not worth the couple of hours it takes to run on my machine to work through a clean refactor.</p>
<div class="cell" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">isinstance</span>(df, pl.DataFrame):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.to_pandas()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"release_speed"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pfx_x"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pfx_z"</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"release_spin_rate"</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"description"</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pitcher"</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"player_name"</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"home_team"</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"platoon_indicator"</span>] <span class="op">=</span> (df[<span class="st">"stand"</span>] <span class="op">==</span> df[<span class="st">"p_throws"</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------- Disclaimer ------------------------------</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># This is outside the scope of what I wanted to learn here. All of the physics</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co"># features are generated from claude code.</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Spin axis is a clock-face angle in degrees</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to a predicted movement direction unit vector</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>spin_rad <span class="op">=</span> np.radians(df[<span class="st">"spin_axis"</span>])</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>pred_x <span class="op">=</span> np.sin(spin_rad)  <span class="co"># horizontal component of predicted movement</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>pred_z <span class="op">=</span> np.cos(spin_rad)  <span class="co"># vertical component of predicted movement</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Actual movement vector</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>act_x <span class="op">=</span> df[<span class="st">"pfx_x"</span>]</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>act_z <span class="op">=</span> df[<span class="st">"pfx_z"</span>]</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Angle between predicted and actual movement vectors</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>dot <span class="op">=</span> pred_x <span class="op">*</span> act_x <span class="op">+</span> pred_z <span class="op">*</span> act_z</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>pred_mag <span class="op">=</span> np.sqrt(pred_x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> pred_z<span class="op">**</span><span class="dv">2</span>)  <span class="co"># always 1 since it's a unit vector</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>act_mag <span class="op">=</span> np.sqrt(act_x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> act_z<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"axis_differential"</span>] <span class="op">=</span> np.degrees(</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    np.arccos(np.clip(dot <span class="op">/</span> (pred_mag <span class="op">*</span> act_mag), <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------------------</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>new_cols <span class="op">=</span> [</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"release_pos_x"</span>,</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"release_pos_z"</span>,</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"release_extension"</span>,</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"platoon_indicator"</span>,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axis_differential"</span>,</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>pitch_name <span class="op">=</span> <span class="st">"4-Seam Fastball"</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="co"># this came from assessing the following and removing bunts</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="co"># df.assign(swing = lambda x: ~x['swing_length'].isna()).groupby(['swing', 'description']).count()</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>swings <span class="op">=</span> [</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hit_into_play"</span>,</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"swinging_strike"</span>,</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"foul_tip"</span>,</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"swinging_strike_blocked"</span>,</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"foul"</span>,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>whiffs <span class="op">=</span> [<span class="st">"swinging_strike"</span>, <span class="st">"swinging_strike_blocked"</span>]</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>df_model_imp <span class="op">=</span> df.copy().query(</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'pitch_name == "</span><span class="sc">{</span>pitch_name<span class="sc">}</span><span class="ss">" and description in </span><span class="sc">{</span>swings<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>)[cols <span class="op">+</span> new_cols]</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>df_model_imp <span class="op">=</span> df_model_imp.dropna()</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Hold out 20 random pitchers for test set</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">42</span>)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>pitchers_imp <span class="op">=</span> df_model_imp[<span class="st">"pitcher"</span>].unique()</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>holdout_pitchers_imp <span class="op">=</span> rng.choice(pitchers_imp, size<span class="op">=</span><span class="dv">20</span>, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>train_mask_imp <span class="op">=</span> <span class="op">~</span>df_model_imp[<span class="st">"pitcher"</span>].isin(holdout_pitchers_imp)</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>feature_cols_imp <span class="op">=</span> [<span class="st">"release_speed"</span>, <span class="st">"pfx_x"</span>, <span class="st">"pfx_z"</span>, <span class="st">"release_spin_rate"</span>] <span class="op">+</span> new_cols</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>y_imp <span class="op">=</span> df_model_imp[<span class="st">"description"</span>].isin(whiffs).astype(<span class="bu">int</span>)</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize features to z-scores (fit on train only)</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>scaler_imp <span class="op">=</span> StandardScaler()</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>X_imp_train <span class="op">=</span> scaler_imp.fit_transform(</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    df_model_imp.loc[train_mask_imp, feature_cols_imp]</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>X_imp_test <span class="op">=</span> scaler_imp.transform(df_model_imp.loc[<span class="op">~</span>train_mask_imp, feature_cols_imp])</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>y_imp_train <span class="op">=</span> y_imp[train_mask_imp].values</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>y_imp_test <span class="op">=</span> y_imp[<span class="op">~</span>train_mask_imp].values</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode home_team as integer park indices (fit on train only)</span></span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>park_categories <span class="op">=</span> pd.Categorical(</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>    df_model_imp.loc[train_mask_imp, <span class="st">"home_team"</span>]</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>).categories</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>n_parks_improved <span class="op">=</span> <span class="bu">len</span>(park_categories)</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>park_idx_imp_train <span class="op">=</span> pd.Categorical(</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>    df_model_imp.loc[train_mask_imp, <span class="st">"home_team"</span>], categories<span class="op">=</span>park_categories</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>).codes</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>park_idx_imp_test <span class="op">=</span> pd.Categorical(</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>    df_model_imp.loc[<span class="op">~</span>train_mask_imp, <span class="st">"home_team"</span>], categories<span class="op">=</span>park_categories</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>).codes</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>player_names_imp_train <span class="op">=</span> df_model_imp.loc[train_mask_imp, <span class="st">"player_name"</span>].values</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>coords_imp <span class="op">=</span> {<span class="st">"obs"</span>: player_names_imp_train}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    RERUN</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">or</span> <span class="kw">not</span> Path(<span class="st">"models/trace_improved.nc"</span>).exists()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">or</span> <span class="kw">not</span> Path(<span class="st">"models/bart_trees_imp.pkl"</span>).exists()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pm.Model(coords<span class="op">=</span>coords_imp) <span class="im">as</span> improved_bart_model:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ------------- DATA -------------------------</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        X_imp_data <span class="op">=</span> pm.Data(<span class="st">"X_imp_data"</span>, X_imp_train)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        y_imp_data <span class="op">=</span> pm.Data(<span class="st">"y_imp_data"</span>, y_imp_train)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        park_idx_imp_data <span class="op">=</span> pm.Data(<span class="st">"park_idx_imp_data"</span>, park_idx_imp_train)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ------------- PARAMS -------------------------</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        mu_bart_imp <span class="op">=</span> pmb.BART(<span class="st">"mu_bart_imp"</span>, X<span class="op">=</span>X_imp_data, Y<span class="op">=</span>y_imp_data, m<span class="op">=</span><span class="dv">150</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        park_sigma_imp <span class="op">=</span> pm.HalfNormal(<span class="st">"park_sigma_imp"</span>, sigma<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        park_effect_imp <span class="op">=</span> pm.Normal(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"park_effect_imp"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span>park_sigma_imp, shape<span class="op">=</span>n_parks_improved</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        mu_imp <span class="op">=</span> pm.Deterministic(</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mu_imp"</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>            mu_bart_imp <span class="op">+</span> park_effect_imp[park_idx_imp_data],</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        p_imp <span class="op">=</span> pm.Deterministic(<span class="st">"p_imp"</span>, pm.math.sigmoid(mu_imp))</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ------------- Likelihood -------------------------</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        pm.Bernoulli(<span class="st">"y_obs_imp"</span>, p<span class="op">=</span>p_imp, observed<span class="op">=</span>y_imp_data)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        idata_imp <span class="op">=</span> pm.sample(draws<span class="op">=</span><span class="dv">2000</span>, chains<span class="op">=</span><span class="dv">2</span>, random_seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    idata_imp.to_netcdf(<span class="st">"models/trace_improved.nc"</span>)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> idata_imp</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    all_trees_imp <span class="op">=</span> <span class="bu">list</span>(mu_bart_imp.owner.op.all_trees)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/bart_trees_imp.pkl"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        pickle.dump(all_trees_imp, f)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/bart_trees_imp.pkl"</span>, <span class="st">"rb"</span>) <span class="im">as</span> f:</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        all_trees_imp <span class="op">=</span> pickle.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="predictions" class="level3">
<h3 class="anchored" data-anchor-id="predictions">Predictions</h3>
<p>I had to use the same <code>_sample_posterior()</code> function here to work with the object in new sessions. In addition to <code>mu</code>, there is also the <code>park_effect</code> parameter that needs to be incorporated.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> xr.open_dataset(<span class="st">"models/trace_improved.nc"</span>, group<span class="op">=</span><span class="st">"posterior"</span>) <span class="im">as</span> post:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    p_imp_train <span class="op">=</span> post[<span class="st">"p_imp"</span>].mean(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)).values</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    park_effects_all <span class="op">=</span> post[<span class="st">"park_effect_imp"</span>].values.reshape(<span class="op">-</span><span class="dv">1</span>, n_parks_improved)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on test set using _sample_posterior + park effects</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>rng_imp <span class="op">=</span> np.random.default_rng(<span class="dv">42</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>mu_bart_test_samples <span class="op">=</span> _sample_posterior(all_trees_imp, X_imp_test, rng<span class="op">=</span>rng_imp, size<span class="op">=</span><span class="dv">500</span>, shape<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># shape: (500, n_test, 1) → (500, n_test)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>mu_bart_test_samples <span class="op">=</span> mu_bart_test_samples.squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample matching park effects from posterior</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>n_samples <span class="op">=</span> mu_bart_test_samples.shape[<span class="dv">0</span>]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>sample_idx <span class="op">=</span> np.random.default_rng(<span class="dv">42</span>).choice(<span class="bu">len</span>(park_effects_all), size<span class="op">=</span>n_samples, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>park_effects_test <span class="op">=</span> park_effects_all[sample_idx][:, park_idx_imp_test]  <span class="co"># (500, n_test)</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>mu_imp_test <span class="op">=</span> mu_bart_test_samples <span class="op">+</span> park_effects_test</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>p_imp_test <span class="op">=</span> (<span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(<span class="op">-</span>mu_imp_test))).mean(axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>calibration_plot(p_imp_train, y_imp_train, label<span class="op">=</span><span class="st">"Train (Improved)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<p><img src="index_files/figure-html/cell-19-output-1.png" width="672" height="480"></p>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>calibration_plot(p_imp_test, y_imp_test, label<span class="op">=</span><span class="st">"Test (Improved)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<p><img src="index_files/figure-html/cell-20-output-1.png" width="672" height="480"></p>
</div>
</div>
<p>Calibration looking even better on the test set!</p>
</section>
<section id="median-whiff-plus-leaderboard-improved" class="level3">
<h3 class="anchored" data-anchor-id="median-whiff-plus-leaderboard-improved">Median whiff plus leaderboard (Improved)</h3>
<div class="cell" data-execution_count="20">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df_train_imp <span class="op">=</span> pl.from_pandas(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    df_model_imp.loc[train_mask_imp].assign(p_hat<span class="op">=</span>p_imp_train)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>).pipe(add_whiff_plus)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>df_test_imp <span class="op">=</span> pl.from_pandas(</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    df_model_imp.loc[<span class="op">~</span>train_mask_imp].assign(p_hat<span class="op">=</span>p_imp_test)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>).pipe(add_whiff_plus)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>leaderboard_imp <span class="op">=</span> (</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    df_train_imp.group_by([<span class="st">"player_name"</span>, <span class="st">"pitcher"</span>])</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    .agg(pl.col(<span class="st">"whiff_plus"</span>).median())</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    .sort(<span class="st">"whiff_plus"</span>, descending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>leaderboard_imp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="37">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (731, 3)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">player_name</th>
<th data-quarto-table-cell-role="th">pitcher</th>
<th data-quarto-table-cell-role="th">whiff_plus</th>
</tr>
<tr class="odd">
<th>str</th>
<th>i64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"Kopech, Michael"</td>
<td>656629</td>
<td>125.205007</td>
</tr>
<tr class="even">
<td>"Ort, Kaleb"</td>
<td>672391</td>
<td>120.787765</td>
</tr>
<tr class="odd">
<td>"Otañez, Michel"</td>
<td>671305</td>
<td>119.323257</td>
</tr>
<tr class="even">
<td>"Núñez, Dedniel"</td>
<td>673380</td>
<td>118.740277</td>
</tr>
<tr class="odd">
<td>"García, Yimi"</td>
<td>554340</td>
<td>118.655864</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>"Barnes, Matt"</td>
<td>598264</td>
<td>82.841306</td>
</tr>
<tr class="even">
<td>"Smyly, Drew"</td>
<td>592767</td>
<td>82.437835</td>
</tr>
<tr class="odd">
<td>"Loutos, Ryan"</td>
<td>702795</td>
<td>82.084812</td>
</tr>
<tr class="even">
<td>"Buchanan, David"</td>
<td>571527</td>
<td>81.49745</td>
</tr>
<tr class="odd">
<td>"Bauers, Jake"</td>
<td>641343</td>
<td>79.865233</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="21">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> xr.open_dataset(<span class="st">"models/trace_improved.nc"</span>, group<span class="op">=</span><span class="st">"posterior"</span>) <span class="im">as</span> post:</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    post_renamed <span class="op">=</span> (</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>        post</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        .assign_coords(p_imp_dim_0<span class="op">=</span>(<span class="st">"p_imp_dim_0"</span>, player_names_imp_train))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        .rename({<span class="st">"p_imp_dim_0"</span>: <span class="st">"obs"</span>})</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    plot_top_imp <span class="op">=</span> whiff_plus_plot(leaderboard_imp, post_renamed, coords_imp, n<span class="op">=</span><span class="dv">10</span>, top<span class="op">=</span><span class="va">True</span>, var<span class="op">=</span><span class="st">"p_imp"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    plot_bottom_imp <span class="op">=</span> whiff_plus_plot(leaderboard_imp, post_renamed, coords_imp, n<span class="op">=</span><span class="dv">10</span>, top<span class="op">=</span><span class="va">False</span>, var<span class="op">=</span><span class="st">"p_imp"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    park_effects <span class="op">=</span> bt.spread_draws(post, <span class="st">"park_effect_imp"</span>, group<span class="op">=</span><span class="va">None</span>).join(</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        pl.DataFrame({<span class="st">"park"</span>: pl.Series(park_categories)}).with_row_index(),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span><span class="st">"park_effect_imp_dim_0"</span>,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span><span class="st">"index"</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>plot_top_imp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="38">
<p><img src="index_files/figure-html/cell-22-output-1.png" width="672" height="480"></p>
</div>
</div>
<div class="cell" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>plot_bottom_imp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="39">
<p><img src="index_files/figure-html/cell-23-output-1.png" width="672" height="480"></p>
</div>
</div>
<p>Again, I don’t feel like refactoring too much – but a more effective plot would have been to combine the top and bottom players together and colored them appropriately. This would show the discrepancy.</p>
</section>
<section id="park-effects" class="level3">
<h3 class="anchored" data-anchor-id="park-effects">Park Effects</h3>
<p>This is what fascinated me and exactly why I was driven to learn some of this. I’m thankful that they made the blog post to show it in action.</p>
<p>Unlike the previous posterior distributions, <code>bayestidy</code> is well suited here as there are only 30 parks, so the dataset is only <code>30 x 2 x 2000</code>. This is where the package and tidy framework can really shine. (on my small machine)</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>park_means <span class="op">=</span> park_effects.group_by(<span class="st">"park"</span>).agg(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"park_effect_imp"</span>).mean().alias(<span class="st">"park_mean"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> park_means.sort(<span class="st">"park_mean"</span>)[<span class="st">"park"</span>].to_list()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>park_effects_plot <span class="op">=</span> park_effects.join(park_means, on<span class="op">=</span><span class="st">"park"</span>).with_columns(</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    sign<span class="op">=</span>pl.when(pl.col(<span class="st">"park_mean"</span>) <span class="op">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    .then(pl.lit(<span class="st">"negative"</span>))</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    .otherwise(pl.lit(<span class="st">"positive"</span>))</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    ggplot(park_effects_plot, aes(<span class="st">"park_effect_imp"</span>, <span class="st">"park"</span>, color<span class="op">=</span><span class="st">"sign"</span>))</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> bt.stat_pointinterval()</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_discrete(limits<span class="op">=</span>order)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_vline(xintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_color_manual(</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>{<span class="st">"negative"</span>: <span class="st">"lightsalmon"</span>, <span class="st">"positive"</span>: <span class="st">"lightblue"</span>}, guide<span class="op">=</span><span class="va">None</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(panel_grid_minor<span class="op">=</span>element_blank())</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<p><img src="index_files/figure-html/cell-24-output-1.png" width="672" height="480"></p>
</div>
</div>
</section>
</section>
<section id="comparing-both-models" class="level2">
<h2 class="anchored" data-anchor-id="comparing-both-models">Comparing both models</h2>
<p>PyMC Labs did a rigorous model comparison with WAIC and log-likelihood. I’m not going to re-implement that here, as this post is mainly for me to reference. What I do find interesting is conveying results visually.</p>
<p>I often have use cases where I want custom plots comparing distributions between multiple models, and this is the beginning framework.</p>
<p>The code below just efficiently extracts what I need out of the two models.</p>
<div class="cell" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> xr.open_dataset(<span class="st">"models/trace.nc"</span>, group<span class="op">=</span><span class="st">"posterior"</span>) <span class="im">as</span> post:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> post[<span class="st">"p"</span>]  <span class="co"># lazy, shape: (chain, draw, obs)</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    p_mean <span class="op">=</span> <span class="bu">float</span>(p.mean())  <span class="co"># triggers a single pass, returns scalar</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    p_std <span class="op">=</span> <span class="bu">float</span>(p.std())</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now only materialize what you need</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    player_means <span class="op">=</span> p.mean(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>))  <span class="co"># shape: (obs,)</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    players <span class="op">=</span> [<span class="st">"Kopech, Michael"</span>]</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> np.where(np.isin(coords[<span class="st">"obs"</span>], players))[<span class="dv">0</span>]</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    df_basic <span class="op">=</span> bt.spread_draws(post[[<span class="st">"p"</span>]].isel(obs<span class="op">=</span>indices), <span class="st">"p"</span>, group<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> xr.open_dataset(<span class="st">"models/trace_improved.nc"</span>, group<span class="op">=</span><span class="st">"posterior"</span>) <span class="im">as</span> post:</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    players <span class="op">=</span> [<span class="st">"Kopech, Michael"</span>]</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> np.where(np.isin(coords_imp[<span class="st">"obs"</span>], players))[<span class="dv">0</span>]</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    df_improved <span class="op">=</span> bt.spread_draws(</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        post[[<span class="st">"p_imp"</span>]].isel(p_imp_dim_0<span class="op">=</span>indices), <span class="st">"p_imp"</span>, group<span class="op">=</span><span class="va">None</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Again, nothing novel in Python. This can all be done with Arviz–it’s more about the syntax and the approach to building the dataset and plot. With this framework, it is already in the dataframe format and easy to join, filter, and derive new metrics from it.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    ggplot(aes(fill<span class="op">=</span><span class="st">"model"</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> bt.stat_halfeye(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>        aes(<span class="st">"p"</span>, <span class="st">"obs"</span>),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>df_basic.with_columns(model<span class="op">=</span>pl.lit(<span class="st">"basic"</span>)),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.4</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> bt.stat_halfeye(</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        aes(<span class="st">"p_imp"</span>, <span class="st">"obs"</span>),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>df_improved.with_columns(</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>            obs<span class="op">=</span>pl.lit(<span class="st">"Kopech, Michael"</span>), model<span class="op">=</span>pl.lit(<span class="st">"improved"</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.4</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(panel_grid_minor<span class="op">=</span> element_blank(), panel_grid_major_y<span class="op">=</span>element_blank(), legend_position<span class="op">=</span><span class="st">'bottom'</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(y <span class="op">=</span> <span class="st">''</span>, title<span class="op">=</span><span class="st">"Kopech estimated parameter comparison"</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<p><img src="index_files/figure-html/cell-26-output-1.png" width="672" height="480"></p>
</div>
</div>
<p>Beautiful!</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This was a multi-faceted learning project for me. I wanted to learn more about BART, and it also lead me to get familiar with using integrated AI tools. As I started recreating this blog post, I found myself referencing other work I had done with this tidy pymc implementation.</p>
<p>I realized it would be a lot more effective to have a package than copying over several functions, and I started to build that with <strong>a ton of help from Claude Code</strong>.</p>
<p>Having this project to go alongside it was great, because I got real immediate feedback on the <code>bayestidy</code> package as I tried to use it. First, Claude provided a lot of the scaffolding from the context of other work I provided. It built out the initial foundation of the package, and of course it built tests that passed.</p>
<p>It’s really hard to go through everything generated and make sure it is covering exactly what you need. I believe even more so for data science and plotting packages.</p>
<p>As I started working with it, I would notice little things off. The visualizations were layered wrong, needed to custom flip what was filled or colored, random things I picked out from experience using tidybayes and replicating it before.</p>
<p>The development process was a lot more of dialogue to a chat promt from me, but I felt like it got well refined during this process of actively trying to use it.</p>
<p>I’m glad I integrated Claude because it gave me a new respect for what that development workflow is and ways I can work better with it. I’m not going to manifest a package with words out of thin air, but if I have a problem to solve and some experience with what I want to do – it can go a long way. In addition to replicating this blog post, I was also able to build a package that I really am interested in along with it. In my spare time less than a week from reading it.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>